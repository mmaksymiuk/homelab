---
# Bootstrap playbook for existing user on server
# Run: ansible-playbook -i inventory/production playbooks/bootstrap.yml --ask-pass --ask-become-pass
# This ensures sudo is configured for the existing user (e.g., maxu)

- name: Bootstrap Homelab Server
  hosts: homelab
  become: true
  gather_facts: false
  
  pre_tasks:
    - name: Install Python for Ansible
      ansible.builtin.raw: apt-get update && apt-get install -y python3 python3-apt
      changed_when: true
    
    - name: Gather facts
      ansible.builtin.setup:
  
  tasks:
    - name: Ensure sudo is installed
      ansible.builtin.apt:
        name: sudo
        state: present
        update_cache: true
    
    - name: Configure sudo for {{ ansible_user }} without password
      ansible.builtin.copy:
        dest: /etc/sudoers.d/{{ ansible_user }}
        content: "{{ ansible_user }} ALL=(ALL) NOPASSWD: ALL\n"
        mode: '0440'
        owner: root
        group: root
        validate: 'visudo -cf %s'
    
    - name: Ensure SSH directory exists for {{ ansible_user }}
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/.ssh
        state: directory
        mode: '0700'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
    
    - name: Display bootstrap complete message
      ansible.builtin.debug:
        msg:
          - "Bootstrap complete!"
          - "User: {{ ansible_user }}"
          - "Next steps:"
          - "1. Copy your SSH key: ssh-copy-id -i ~/.ssh/id_rsa.pub {{ ansible_user }}@{{ inventory_hostname }}"
          - "2. Run: ansible-playbook -i inventory/production playbooks/site.yml"
