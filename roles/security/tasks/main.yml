---
# Note: User creation and sudo configuration are handled by bootstrap.sh
# This role focuses on security hardening only

- name: Check if SSH key authentication is working
  ansible.builtin.command: "ssh -o BatchMode=yes -o ConnectTimeout=5 {{ ansible_user }}@{{ ansible_host }} echo 'SSH key auth OK'"
  delegate_to: localhost
  become: false
  changed_when: false
  ignore_errors: true
  register: ssh_key_test

- name: Warn if SSH key authentication not confirmed
  ansible.builtin.fail:
    msg: |
      WARNING: SSH key authentication may not be properly configured!
      
      Before proceeding, ensure you can SSH without password:
        ssh {{ ansible_user }}@{{ ansible_host }}
      
      If this prompts for a password, run from your local machine:
        ssh-copy-id -i ~/.ssh/id_rsa.pub {{ ansible_user }}@{{ ansible_host }}
      
      This check can be bypassed with: --extra-vars "skip_ssh_check=true"
  when:
    - ssh_key_test.rc != 0
    - skip_ssh_check | default(false) | bool == false

- name: Harden SSH configuration
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    mode: '0644'
    owner: root
    group: root
  notify: Restart SSH

- name: Disable root login
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin'
    line: 'PermitRootLogin no'
  notify: Restart SSH

- name: Disable password authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PasswordAuthentication'
    line: 'PasswordAuthentication no'
  notify: Restart SSH

- name: Enable pubkey authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PubkeyAuthentication'
    line: 'PubkeyAuthentication yes'
  notify: Restart SSH

- name: Install fail2ban
  ansible.builtin.apt:
    name:
      - fail2ban
      - python3-systemd
    state: present
  when: fail2ban_enabled | default(true)

- name: Configure fail2ban
  ansible.builtin.template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    mode: '0644'
  notify: Restart fail2ban
  when: fail2ban_enabled | default(true)

- name: Ensure fail2ban is enabled and running
  ansible.builtin.systemd:
    name: fail2ban
    state: started
    enabled: true
    daemon_reload: true
  when: fail2ban_enabled | default(true)
  ignore_errors: true

- name: Install UFW
  ansible.builtin.apt:
    name: ufw
    state: present
  when: ufw_enabled | default(true)

- name: Reset UFW
  ansible.builtin.ufw:
    state: reset
  when: ufw_enabled | default(true)

- name: Allow SSH
  ansible.builtin.ufw:
    rule: allow
    port: "{{ ssh_port | default(22) }}"
    proto: tcp
  when: ufw_enabled | default(true)

- name: Allow Cockpit
  ansible.builtin.ufw:
    rule: allow
    port: '9090'
    proto: tcp
  when: ufw_enabled | default(true)

- name: Allow trusted network access
  ansible.builtin.ufw:
    rule: allow
    src: "{{ item }}"
  loop: "{{ ufw_trusted_networks | default(['192.168.1.0/24']) }}"
  when: ufw_enabled | default(true)

- name: Enable UFW
  ansible.builtin.ufw:
    state: enabled
    policy: deny
  when: ufw_enabled | default(true)
